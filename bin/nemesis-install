#!/bin/bash
#
# nemesis-install.sh
# (c) 2013 Sam caldwell.  All Rights Reserved.
#
set -e

export DEBUG=0
[ $DEBUG -eq 1 ] && set -x

configure_installer(){
	export TIME_SERVER="0.pool.ntp.org"
}

init_profile(){
	[ -f /root/.vimrc ] && rm /root/.vimrc
	[ -f /etc/profile.d/nemesis.profile ] && rm /etc/profile.d/nemesis.profile
	ln -s /srv/nemesis/etc/vimrc /root/.vimrc
	ln -s /srv/nemesis/etc/nemesis.profile /etc/profile.d/nemesis.profile
	. /etc/profile
}

base_install(){
	#
	#base installation
	#
	init_profile && \
	echo "Updating the clock..." && \
	time ntpdate $TIME_SERVER && \
	echo "installing software packages" && \
	apt-get install vim -y && \
	apt-get install openssh-server openssh-client -y && \
	apt-get install nginx-full -y && \
	apt-get install nodejs -y && \
	apt-get install npm -y && \
	echo "software is now installed...configuring system." && \
	rm -f /etc/nginx/sites-enabled/* && \
	rm -rf /etc/nginx/sites-available && \
	ln -sf /srv/nemesis/etc/nginx/sites-available /etc/nginx/sites-available && \
	ln -sf /srv/nemesis/etc/nginx/sites-available/${SERVER_TYPE} /etc/nginx/sites-enabled/${SERVER_TYPE} && \
	[ -f /etc/init/${SERVER_TYPE} ] && rm /etc/init/${SERVER_TYPE}
	ln -sf /srv/nemesis/etc/init/${SERVER_TYPE} /etc/init/${SERVER_TYPE} && \
	ln -sf /srv/nemesis/etc/init.d/nemesis-${SERVER_TYPE} /etc/init.d/nemesis-${SERVER_TYPE} && \ 
	configure-network && \
	echo "Base installation complete for ${SERVER_TYPE}" && \
	return 0
	return 1
}
[ "$(whoami)" != "root" ] && echo "$0 must be run as root." && exit 1
[ -z "$1" ] && echo "Missing argument." && exit 1
export SERVER_TYPE=$(echo "$1" | tr -dc a-z)

echo "Starting install ( $SERVER_TYPE )..."
configure_installer

case "$SERVER_TYPE" in 
	audit)
		base_install $SERVER_TYPE
		[ $? -ne 0 ] && echo "One or more errors occurred." && exit 1
		#add more steps here
		exit 0
	;;
	cipher)
		base_install $SERVER_TYPE
		[ $? -ne 0 ] && echo "One or more errors occurred." && exit 1
		#add more steps here
		exit 0
	;;
	broker)
		base_install $SERVER_TYPE
		[ $? -ne 0 ] && echo "One or more errors occurred." && exit 1
		#add more steps here
		exit 0
	;;
	keys)
		base_install $SERVER_TYPE
		[ $? -ne 0 ] && echo "One or more errors occurred." && exit 1
		#add more steps here
		exit 0
	;;
	*)
		echo "USAGE: $0 [broker,cipher,keys]"
		exit 1
	;;
esac
